<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sushidanopakuri</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://use.fontawesome.com/releases/v7.1.0/css/all.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Ubuntu+Sans+Mono:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
    <style>
        /* * 認証が完了するまでページ内容を非表示にし、
         * 認証されていないコンテンツが一瞬表示される（FOUC）のを防ぐ 
         */
        body {
            visibility: hidden;
            /* * オプション: 
             * display:none と違い、レイアウトは維持されるため、
             * 認証成功時の表示ガクツキが少ない
             */
        }
    </style>

    <script>
        // <head> 内で即時実行
        (async () => {
            try {
                const response = await fetch('/api/check');

                if (!response.ok) {
                    // 認証失敗 (401など) だったらリダイレクト
                    window.location.href = '/password.html';

                    // ★重要: リダイレクトが実行されるまで、これ以降の処理はしない
                    return; 
                }

                // 認証成功 (200) 
                // -> 非表示にしていた body を表示する
                document.body.style.visibility = 'visible';
            } catch (error) {
                // APIリクエスト自体が失敗した場合もリダイレクト
                console.error('Auth check failed:', error);
                window.location.href = '/password.html';
            }
        })();
    </script>
    <script>
      window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>
 
</head>
<body>
    <div id="splash">
        <img src="ryosuke.png" alt="Logo" class="logo">
    </div>
    <div id="main">
        <div id="center-box">
            <!-- 残り時間（秒） -->
            <label id="remaining-time" for="jikan">残り時間: 60秒</label>
            <progress id="jikan" max="60" value="0" style="display: none !important;"></progress>
            <label for="renda">連打メーター</label>
            <div class="progress-container">
                <progress id="renda" value="0" max="130" data-color-stops="28,59,93,130"></progress>
                <div class="target-marker" data-target="28"></div>
                <div class="target-marker" data-target="59"></div>
                <div class="target-marker" data-target="93"></div>
                <div class="target-marker" data-target="130"></div>
            </div>
            <label id="jikan-plus"></label>
            <div id="odai-box">
                <p id="yomi-text"></p>
                <p id="box-text"></p>
                <p id="possible"></p>
            </div>
            <!-- ゲットした皿の数の合計 -->     
            <p id="total_got_odai"></p>
            <table>
                <caption id="got_odai">げっちゅした皿</caption>
                <thead>
                    <tr>
                        <th scope="col">100</th>
                        <th scope="col">180</th>
                        <th scope="col">240</th>
                        <th scope="col">380</th>
                        <th scope="col">500</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th scope="row" id="100_count">0</th>
                        <th scope="row" id="180_count">0</th>
                        <th scope="row" id="240_count">0</th>
                        <th scope="row" id="380_count"">0</th>
                        <th scope="row" id="500_count">0</th>
                    </tr>
            </table>
            <p id="keys-per-second"></p>
            <div class="button-box">
                <button class="result-button retry">もう一度</button>
                <button class="result-button select-course">コース選択</button>
            </div>
        </div>
        <div id="special-mode-result-box">
            <p id="course-result"></p>
            <p id="result-keys-per-second"></p>
            <p id="result-correct-percent"></p>
            <img src="marusan_dance.gif" alt="kawaii" id="result-image">
            <div class="button-box">
                <button class="result-button retry">もう一度</button>
                <button class="result-button select-course">コース選択</button>
            </div>
        </div>
        <div id="result-box">
            <p id="course-result"></p>
            <p id="result-total">〜円分のお寿司をゲット！</p>
            <p id="haratta">3000円 払って・・・</p>
            <div id="otoku-box">
                <p id="otoku">円分〜でした</p>
            </div>
            <table id="result-table">
                <caption>結果</caption>
                <thead>
                    <tr>
                        <th scope="col">正しく打ったキーの数</th>
                        <th scope="col">平均キータイプ数</th>
                        <th scope="col">ミスタイプ数</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th scope="row" id="correct_keys_count">0</th>
                        <th scope="row" id="average_keys_count">0</th>
                        <th scope="row" id="incorrect_keys_count">0</th>
                    </tr>
                </tbody>
            </table>
            <div class="button-box">
                <button class="result-button retry">もう一度</button>
                <button class="result-button select-course">コース選択</button>
            </div>
        </div>
        <div id="start-box">
            <p id="course"></p>
            <p id="start-text">スペースかEnterキーを押すとスタートします</p>
            <div class="button-box">
                <button class="result-button select-course" id="start-box-button">コース選択</button>
            </div>
        </div>
        <div id="select-box" class="scroll-a">
            <p id="select-text">コースを選択してください</p>
            <div class="switch">
                <label for="cmn-toggle-4" class="switch-label">一発勝負</label>
              <input id="cmn-toggle-4" class="cmn-toggle cmn-toggle-round-flat" type="checkbox">
              <label for="cmn-toggle-4"></label>
            </div>
            
            <div id="otegaru" class="course-option">
                <div class="course-primary">
                    <span id="otegaru-text" class="course-name">お手軽</span>
                    <span class="course-price">3,000円コース</span>
                </div>
                <div class="course-secondary">
                    <span class="course-description">文字数　：2〜7文字</span>
                    <span class="course-description">制限時間：60秒</span>
                </div>
            </div>
            <div id="osusume" class="course-option">
                <div class="course-primary">
                    <span id="osusume-text" class="course-name">お勧め</span>
                    <span class="course-price">5,000円コース</span>
                </div>
                <div class="course-secondary">
                    <span class="course-description">文字数　：5〜10文字</span>
                    <span class="course-description">制限時間：90秒</span>
                </div>
            </div>
            <div id="koukyuu" class="course-option">
                <div class="course-primary">
                    <span id="koukyuu-text" class="course-name">高級</span>
                    <span class="course-price">10,000円コース</span>
                </div>
                <div class="course-secondary">
                    <span class="course-description">文字数　：9〜14文字以上</span>
                    <span class="course-description">制限時間：120秒</span>
                </div>
            </div>
            <div id="ai-mode" class="course-option">
                <div class="course-primary">
                    <span id="ai-mode-text" class="course-name">なぞのAIモード？<span class="beta-mark">Beta</span></span>
                    <span class="course-price">いやっほー</span>
                </div>
                <!--
                <div class="course-secondary">
                    <span class="course-description">文字数　：？</span>
                    <span class="course-description">制限時間：？</span>
                </div>
                -->
            </div>
            <div id="wiki-mode" class="course-option">
                <div class="course-primary">
                    <span id="wiki-mode-text" class="course-name">Wikiモード<span class="beta-mark">Beta</span></span>
                    <span class="course-price">ﾅﾆｺﾚ(´・ω・｀)</span>
                </div>
            </div>
        </div>
        <div id="end-box">
            <p id="end-text">終了！</p>
        </div>
        <div id="wait-box">
            <img src="marusan_dance.gif" alt="Loading...">
            <div class="loader3">
              <div class="bar"></div>
              <div class="bar"></div>
              <div class="bar"></div>
              <div class="bar"></div>
            </div>
            <p id="wait-text">サーバーを待機中...</p>
        </div>
        <div id="ai-config-box">
            <p id="ai-config-text">AIモードの設定</p>
            <div class="switch">
                <label for="cmn-toggle-5" class="switch-label">プロンプトを変更</label>
                <input id="cmn-toggle-5" class="cmn-toggle cmn-toggle-round-flat" type="checkbox">
                <label for="cmn-toggle-5"></label>
            </div>
            <textarea placeholder="変な面白おかしい文章を書いて！ 奇妙な話でも、日常についての話でもなんでもいいです！ 「わかりました」とかはなしで文章だけ　300文字を目安に" 
                maxlength="100" oninput="limitTextLength();" id="entered-characters" rows="3" disabled="true">
            </textarea>
            <p>残りの文字数：<span id="remaining-characters">50</span></p>
            <div class="button-box">
                <button class="result-button select-course">コース選択に戻る</button>
                <button id="ai-config-button" class="result-button">決定</button>
            </div>
        </div>
    </div>
    <script src="script.js"></script>
</body>
</html>